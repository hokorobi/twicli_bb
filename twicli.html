<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=280">
<title>twicli</title>
<style type="text/css"><!--
body { background-color: transparent; margin: 1px; min-height: 500px; }
img { border: 0; }
hr { margin: 0; padding: 0; }
iframe { display: none; }

#control { position: fixed; top: 0; left: 0; width: 100%; height: 52px; border-bottom: solid 1px black; background-color: white; z-index: 3; background-color: #eee; }
#loading { opacity: 0.5; position: absolute; top: 6px; width: 100%; height: 20px; z-index: 3; text-align: center; }
#fst { position: absolute; left: 1px; top: 1px; width: 94%; height: 30px; font-size: small; }
#go { text-decoration: none; position: absolute; left: 95%; top: 1px; }
#rst { text-decoration: none; position: absolute; left: 95%; top: 16px; }
#menu { position: absolute; left: 0px; top: 32px; height: 20px; }
#menu a { display: block; float: left; font-size: 13px; height: 18px; border: black solid 1px; border-bottom: 0; background-color: #ccc; color: #242; padding: 0 4px; margin: 0 2px; text-decoration: none; font-family: sans-serif; }
#menu a.sel { height: 20px; background-color: #fff; color: #002; border-bottom: #fff; }

#tw, #tw2 { position: absolute; left: 0px; top: 52px; width: 100%; font-size: small; }
#tw2 { background-color: #fec; display: none; min-height: 448px; }
#tw div { border-bottom: solid 1px #777; }
#tw div div, #tw2 div div { padding: 2px; border-bottom: solid 1px #999; }
.status { text-decoration: none; color: black; cursor: pointer; }
.date { color: #999; font-size: x-small; }
.fromme { background-color: #cfc; }
.tome { background-color: #ccf; }
.inreply { text-decoration: none; font-size: medium; }
.lock { position: relative; top: 2px; left: 0; }
.close { color: red; }
#next { text-align: center; background-color: #999; color: #fec; cursor: pointer; }
#rep { display: none; background-color: #fee; position: absolute; width: 90%; left: 4%; top: 200px; border: #666 4px solid; z-index: 2; padding: 2px; font-size: small; }
#user_info { margin: 1px; border: #888 solid 1px: }
#user_info td { font-size: small; }
--></style>
</head>
<body onLoad="init()">
<div id="control">
<iframe name="tx"></iframe>
<!--発言フォーム-->
<form name="frm" action="http://twitter.com/statuses/update.xml" method="POST" target="tx">
<textarea id="fst" type="text" name="status" onkeyup="if (this.value.indexOf('\n') >= 0) return press(1)" onkeypress="return press(event)"></textarea>
<input type="hidden" name="source" value="twicli">
<a id="go" href="javascript:void press(1)"><img src="go.png"></a>
<a id="rst" href="javascript:void resetFrm()"><img src="clr.png"></a>
<div id="loading"><img src="loading.gif"></div></form>
<!--fav/followフォーム-->
<form name="favf" action="" method="POST" target="tx"></form>
<!--メニュー-->
<div id="menu">
<a id="TL" class="sel" href="javascript:void switchTL()">TL</a>
<a id="reply" href="javascript:void switchReply()">reply</a>
<a id="user" href="javascript:void switchUser()">user</a>
<a id="direct" href="javascript:void switchDirect()">direct</a>
<a id="help" href="javascript:void switchHelp()">?</a>
</div>
</div>
<!--タイムライン-->
<div id="tw"></div>
<div id="tw2"><div id="tw2h"></div><div id="tw2c"></div></div>
<div id="rep"><a href="javascript:closeRep()" class="close">[x]</a><div id="reps"></div></div>
<!---->

<script type="text/javascript">
var nr_limit = 500;				// 表示する発言数の上限

function $(id) { return document.getElementById(id); }
var nr_tw = 0;
var seq = (new Date).getTime();
var since_id = null;
var in_reply_to_user = null;
var myname = null;
var last_user = null;
var update_ele = false;
var update_ele2 = false;
var direct_ele1 = false;
var direct_ele2 = false;
var direct1 = false;
var direct2 = false;
var reply_ele = false;
var rep_top = 0;
var selected_menu = $("TL");
var failover_timeout = false;
// クロスドメインなJavaScriptを呼び出し
function loadXDomainScript(url, ele) {
	if (ele)
		ele.parentNode.removeChild(ele);
	ele = document.createElement("script");
	ele.src = url;
	ele.type = "text/javascript";
	document.body.appendChild(ele);
	return ele;
}
// 要素の位置を取得
function cumulativeOffset(ele) {
	var top = 0, left = 0;
	do {
		top += ele.offsetTop  || 0;
		left += ele.offsetLeft || 0;
		ele = ele.offsetParent;
	} while (ele);
	return [left, top];
}
// ローディング表示ON、twit更新
function reload(to) {
	$("loading").style.display = "block";
	setTimeout(update, to);
}
// enterキーで発言
function press(e) {
	if (e != 1 && e.keyCode != 13) return true;
	document.frm.status.value = document.frm.status.value.replace(/\n/g, "");
	if (document.frm.status.value == '') { // 空欄であればTimeline更新のみ
		reload(0);
		return false;
	}
	if (document.frm.status.value.indexOf("@"+in_reply_to_user) < 0) // @ユーザが含まれているときのみ返信先を指定
		setReplyId(false);
	in_reply_to_user = "";
	document.frm.status.select();
	setTimeout(resetFrm, 10); // twit送信後にフォームをクリア
	reload(3000); // 送信3秒後にTimelineを更新
	document.frm.submit();
}
// フォームの初期化
function resetFrm() {
	document.frm.reset();
	setReplyId(false);
}
// reply先の設定/解除
function setReplyId(id) {
	var repid = $('in_reply_to_status_id');
	if (repid)
		repid.parentNode.removeChild(repid);
	if (id) {
		repid = document.createElement('input');
		repid.type = 'hidden';
		repid.id = repid.name = 'in_reply_to_status_id';
		repid.value = id;
		document.frm.appendChild(repid)
	}
}
// reply
function replyTo(user, id) {
	if (window.getSelection() && window.getSelection().toString() == '') {
		in_reply_to_user = user;
		document.frm.status.value += "@" + user + " ";
		setReplyId(id);
		document.frm.status.select();
	}
}
// reply先を表示
function dispReply(id,ele) {
	var d = $((selected_menu.id == "TL" ? "tw" : "tw2") + "-" + id);
	if (!d) {
		$("loading").style.display = "block";
		rep_top = cumulativeOffset(ele)[1] + 20;
		reply_ele = loadXDomainScript('http://twitter.com/statuses/show/'+id+'.json?callback=dispReply2', reply_ele);
		return;
	}
	closeRep();
	var top = cumulativeOffset(d)[1];
	var h = d.offsetHeight;
	var sc_top = window.pageYOffset || document.body.scrollTop;
	var win_h = window.innerHeight;
	if (top < sc_top) scrollTo(0, top);
	if (sc_top+win_h < top+h) scrollTo(0, top+h-win_h);
	var old = d.style.backgroundColor;
	d.style.backgroundColor = '#fcc';
	setTimeout(function(){d.style.backgroundColor = old}, 2000);
}
// reply先をoverlay表示 (Timelineに無い場合)
function dispReply2(tw) {
	$("loading").style.display = "none";
	$('reps').innerHTML = makeHTML(tw);
	$('rep').style.display = "block";
	$('rep').style.top = rep_top;
}
// replyのoverlay表示を閉じる
function closeRep() {
	$('rep').style.display = 'none';
}
// 最新タイムラインを取得
function update() {
	update_ele = loadXDomainScript('http://twitter.com/statuses/friends_timeline?seq=' + (seq++) +
									'&callback=twShow' + (since_id ? '&since_id='+since_id : ''), update_ele);
}
// twitのHTML表現を生成
function dateFmt(d) {
	function d2(dig) { return (dig>9?"":"0") + dig }
	return (d.getMonth()+1) + "/" + d.getDate() + " " + d.getHours() + ":" + d2(d.getMinutes()) + ":" + d2(d.getSeconds());
}
function makeHTML(tw, no_name) {
	return /*fav*/ '<img align="right" src="http://assets3.twitter.com/images/icon_star_'+(tw.favorited?'full':'empty')+'.gif" ' +
			'onClick="fav(this,' + tw.id + ')">' +
		 (!no_name ?
			//ユーザアイコン
			(tw.user.url ? '<a target="twitter" href="'+tw.user.url+'">' : '') +
			'<img align="left" width="24" height="24" src="' + tw.user.profile_image_url + '">' + (tw.user.url ? '</a>' : '') +
			/*ダイレクトメッセージの方向*/ (tw.d_dir == 1 ? '<b>←</b> ' : tw.d_dir == 2 ? '<b>→</b> ' : '') +
			//名前
			"<a href=\"javascript:switchUser('" + tw.user.screen_name + "')\">" + tw.user.screen_name +
			 /*プロフィールの名前*/ (tw.user.name!=tw.user.screen_name ? '('+tw.user.name+')' : '') + '</a>' +
			 /* protected? */ (tw.user.protected ? '<img class="lock" src="http://assets0.twitter.com/images/icon_red_lock.gif">' : '')
		: '') +
		//本文クリックで@追加
		" <span onClick=\"replyTo('" + tw.user.screen_name + "'," + tw.id + ")\" class=\"status\">" +
		//本文 (https〜をリンクに置換 + @をtwitter本家へのリンクに置換)
		tw.text.replace(/https?:\/\/[\w!#$%&'()*+,.\/:;=?@~-]+/g, " <a onClick=\"event.stopPropagation();\" target=\"_blank\" href=\"$&\">$&</a>")
				.replace(/@([\w-]+)/g, "<a onClick=\"event.stopPropagation();\" " +
							"href=\"javascript:switchUser('$1')\">$&</a>").replace(/\r?\n|\r/g, "<br>") + '</span>' +
		//日付
		'<span class="date">' + dateFmt(new Date(tw.created_at)) + '</span>' +
		//返信元へのリンク
		(tw.in_reply_to_status_id ? ' <a class="inreply" href="#" onClick="dispReply('+tw.in_reply_to_status_id+',this);return false;">☞</a>' : '') +
		'<br clear="left">';
}
// favoriteの追加(f=true)/削除(f=false)
function fav(img, id) {
	var f = img.src.indexOf('empty') != -1;
	document.favf.action = 'http://twitter.com/favourings/' + (f ? 'create' : 'destroy') + '/' + id + '.xml';
	document.favf.submit();
	img.src = 'http://assets3.twitter.com/images/icon_star_' + (f ? 'full' : 'empty') + '.gif';
}
// followとremove
function follow(f) {
	document.favf.action = 'http://twitter.com/friendships/' + (f ? 'create' : 'destroy') + '/' + last_user + '.xml';
	document.favf.submit();
	$("loading").style.display = "block";
	setTimeout(switchUser, 3000);
}
// 自分の最新の発言を受信
function twUser(tw) {
	myname = last_user = tw[0].user.screen_name;
	$("user").innerHTML = last_user;
}
// ダイレクトメッセージ一覧の受信
function twDirect1(tw) {
	direct1 = tw;
	if (direct2)
		twDirectShow();
}
function twDirect2(tw) {
	direct2 = tw;
	if (direct1)
		twDirectShow();
}
function twDirectShow() {
	var direct = direct1.concat(direct2).sort(function(a,b){return b.id - a.id});
	direct = direct.map(function(d){
		if (d.recipient_screen_name == myname) {
			d.user = d.sender;
			d.d_dir = 1;
		} else {
			d.user = d.recipient;
			d.d_dir = 2;
		}
		return d;
	});
	twShow2(direct);
	direct1 = direct2 = false;
}
// API制限情報の受信
function twLimit(lim) {
	$("loading").style.display = "none";
	$("tw2c").innerHTML = "<b>Twitter API status:</b><br>" +
					"hourly limit : " + lim.remaining_hits + " / " + lim.hourly_limit + "<br>" +
					"reset at : " + dateFmt(new Date(lim.reset_time));
}
// follow関係の受信
function twFollow(fl) {
	fl = fl == "true";
	$("user_info").innerHTML += '<input type="button" value="' + (fl ? 'Remove ' : 'Follow ') + last_user +
					'" onClick="follow('+!fl+')">';
}
// 受信twitを表示
function twShow(tw) {
	twShowToNode(tw, $("tw"), false, false, true, true);
}
function twShow2(tw) {
	var user_info = $("user_info");
	var tmp = $("tmp");
	if (tmp) tmp.parentNode.removeChild(tmp);
	if (cur_page == 1 && user_info && tw.length > 0) {
		var user = tw[0].user;
		user_info.innerHTML = '<table><tr><td><img align="left" src="' + user.profile_image_url + '"></td><td>' +
								'<b>' + user.screen_name + '</b> / <b>' + user.name + '</b><br>' +
								(user.location ? '<b>Location</b>: ' + user.location + '<br>' : '') +
								(user.url ? '<b>URL</b>: <a target="twitter" href="' + user.url + '">' + user.url + '</a><br>' : '') +
								(user.description ? user.description : '') +
								'</td></tr></table><a target="twitter" href="http://twitter.com/' + user.screen_name + '">→Twitter</a> ';
		if (myname != user.screen_name)
			update_ele2 = loadXDomainScript('http://twitter.com/friendships/exists.json?seq=' + (seq++) +
									'&user_a=' + myname + '&user_b=' + user.screen_name + '&callback=twFollow', update_ele2);
	}
	twShowToNode(tw, $("tw2c"), !!user_info, cur_page > 1);
	if (selected_menu.id == "reply" || selected_menu.id == "user")
		$("tw2c").innerHTML += '<div onClick="getNext(this)" id="next">▽</div>';
}
function twShowToNode(tw, twNode, no_name, after, animation, check_since) {
	$('loading').style.display = 'none';
	if (failover_timeout) clearTimeout(failover_timeout);
	failover_timeout = false;
	var len = tw.length;
	if (len == 0) return;
	var pNode = document.createElement('div');
	var dummy = pNode.appendChild(document.createElement('div'));
	for (var i = len-1; i >= 0; i--) {
		if (check_since && since_id && since_id >= tw[i].id || $(twNode.id + "-" + tw[i].id))
			continue;
		if (tw[i].user) {
			var s = document.createElement('div');
			s.id = twNode.id + "-" + tw[i].id;
			s.innerHTML = makeHTML(tw[i], no_name);
			if (tw[i].d_dir == 1 || tw[i].text.indexOf('@'+myname+' ') != -1)
				s.className = "tome";
			if (tw[i].d_dir == 2 || tw[i].user.screen_name == myname)
				s.className = "fromme";
			pNode.insertBefore(s, pNode.childNodes[0]);
		}
	}
	pNode.removeChild(dummy);
	pNode.style.overflow = "hidden";
	var animation2 = animation && (window.pageYOffset || document.body.scrollTop) < 10;
	var maxH;
	if (animation2) { // get maxH
		twNode.appendChild(pNode);
		maxH = pNode.clientHeight;
		twNode.removeChild(pNode);
		pNode.style.minHeight = 0;
	}
	if (after)
		twNode.appendChild(pNode);
	else
		twNode.insertBefore(pNode, twNode.childNodes[0]);
	if (animation2)
		animate(pNode, maxH, (new Date).getTime());
	else if (animation) {
		$('rep').style.top = (rep_top += pNode.clientHeight);
		scrollBy(0, pNode.clientHeight+1);
	}
	if (animation) {
		nr_tw += len;
		while (nr_tw > nr_limit) {
			var last_node = twNode.childNodes[twNode.childNodes.length-1];
			nr_tw -= last_node.childNodes.length;
			twNode.removeChild(last_node);
		}
	}
	if (check_since) since_id = tw[0].id;
}
// 新規twitの出現アニメーション処理
function animate(elem, max, start) {
	var t = (new Date).getTime();
	if (start+1000 <= t)
		return elem.style.maxHeight = 'none';
	elem.style.maxHeight = Math.ceil(max*(1-Math.cos((t-start)/1000*Math.PI))/2);
	setTimeout(animate, 50, elem, max, start);
}
// 次ページ取得
function getNext(ele) {
	var tmp = document.createElement("div");
	tmp.id = "tmp";
	tmp.innerHTML = "<p></p>";
	ele.parentNode.appendChild(tmp);
	ele.parentNode.removeChild(ele);
	$("loading").style.display = "block";
	if (selected_menu.id == "user")
		update_ele2 = loadXDomainScript('http://twitter.com/statuses/user_timeline.json?seq=' + (seq++) +
								'&page=' + (++cur_page) + '&id=' + last_user + '&callback=twShow2', update_ele2);
	else if (selected_menu.id == "reply")
		update_ele2 = loadXDomainScript('http://twitter.com/statuses/replies.json?seq=' + (seq++) +
								'&page=' + (++cur_page) + '&callback=twShow2', update_ele2);
}
// タイムライン切り替え
function switchTo(id) {
	selected_menu.className = "";
	selected_menu = $(id);
	selected_menu.className = "sel";
	$("tw").style.display = id=="TL"?"block":"none";
	$("tw2h").innerHTML = "";
	$("tw2c").innerHTML = "";
	$("tw2").style.display = id!="TL"?"block":"none";
	$("rep").style.display = "none";
	scrollTo(0, 1);
	cur_page = 1;
}
function switchTL() {
	switchTo("TL");
}
function switchReply() {
	switchTo("reply");
	$("loading").style.display = "block";
	update_ele2 = loadXDomainScript('http://twitter.com/statuses/replies.json?seq=' + (seq++) +
										'&callback=twShow2', update_ele2);
}
function switchUser(user) {
	if (!user) user = last_user;
	last_user = user;
	$("user").innerHTML = user;
	switchTo("user");
	$("tw2h").innerHTML = "<div id=\"user_info\">loading ...</div>";
	$("loading").style.display = "block";
	update_ele2 = loadXDomainScript('http://twitter.com/statuses/user_timeline.json?seq=' + (seq++) +
										'&id=' + user + '&callback=twShow2', update_ele2);
}
function switchDirect() {
	switchTo("direct");
	$("loading").style.display = "block";
	direct_ele1 = loadXDomainScript('http://twitter.com/direct_messages.json?seq=' + (seq++) +
										'&callback=twDirect1', direct_ele1);
	direct_ele2 = loadXDomainScript('http://twitter.com/direct_messages/sent.json?seq=' + (seq++) +
										'&callback=twDirect2', direct_ele2);
}
function switchHelp() {
	switchTo("help");
	$("tw2h").innerHTML = '<p><a target="twitter" href="index.html"><b>twicli</b></a> : browser-base Twitter client</p><hr>' +
								'<p><form onSubmit="switchUser($(\'user_id\').value); return false;">show user info : @<input type="text" size="15" id="user_id"></form></p><hr>';
	$("loading").style.display = "block";
	update_ele2 = loadXDomainScript('http://twitter.com/account/rate_limit_status.json?seq=' + (seq++) +
										'&id=' + user + '&callback=twLimit', update_ele2);
}
// 初期化
function init() {
	setTimeout(scrollTo, 0, 0, 1);
	// 初回アップデート
	setTimeout(update, 0);
	setInterval(update, 30*1000);
	// ログインしていなかったときなどに15秒で本家にリダイレクト
	failover_timeout = setTimeout("location.href='http://twitter.com/home'", 15*1000);
}

// ホイールの回転でスクロール (スクロール不可のウィンドウ・フレーム内で有効)
function wheel(event) {
	var delta = 0;
	if (!event) event = window.event;
	if (event.wheelDelta) {
		delta = event.wheelDelta/10;
	} else if (event.detail)
		delta = -event.detail;
	if (navigator.userAgent.indexOf("Gecko/") != -1)
		delta *= 10;
	if (delta)
		scrollBy(0, -delta);
	if (event.preventDefault)
		event.preventDefault();
	event.returnValue = false;
}
if (window.addEventListener) window.addEventListener('DOMMouseScroll', wheel, false);
window.onmousewheel = document.onmousewheel = wheel;
</script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline.json?count=1&callback=twUser"></script>
</body>
</html>
